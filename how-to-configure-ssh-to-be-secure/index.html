<!DOCTYPE html><html lang="en-gb"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>How to install and configure SSH to be secure - blogHez</title><meta name="description" content="It should&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://baronhez.github.io/how-to-configure-ssh-to-be-secure/"><link rel="alternate" type="application/atom+xml" href="https://baronhez.github.io/feed.xml"><link rel="alternate" type="application/json" href="https://baronhez.github.io/feed.json"><meta property="og:title" content="How to install and configure SSH to be secure"><meta property="og:image" content="https://baronhez.github.io/media/posts/10/ssh-transformed11.jpeg"><meta property="og:site_name" content="blogHez"><meta property="og:description" content="It should&hellip;"><meta property="og:url" content="https://baronhez.github.io/how-to-configure-ssh-to-be-secure/"><meta property="og:type" content="article"><link rel="stylesheet" href="https://baronhez.github.io/assets/css/style.css?v=e593e396d418be8ac87b451f827877c0"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://baronhez.github.io/how-to-configure-ssh-to-be-secure/"},"headline":"How to install and configure SSH to be secure","datePublished":"2022-08-27T16:33","dateModified":"2022-08-27T17:17","image":{"@type":"ImageObject","url":"https://baronhez.github.io/media/posts/10/ssh-transformed11.jpeg","height":862,"width":1300},"description":"It should&hellip;","author":{"@type":"Person","name":"Jonathan Ródenas López","url":"https://baronhez.github.io/jonathan/jonathan-rodenas-lopez/"},"publisher":{"@type":"Organization","name":"Jonathan Ródenas López"}}</script></head><body><div class="site-container"><header class="top" id="js-header"><a class="logo" href="https://baronhez.github.io/">blogHez</a></header><main><article class="post"><div class="hero"><figure class="hero__image hero__image--overlay"><img src="https://baronhez.github.io/media/posts/10/ssh-transformed11.jpeg" srcset="https://baronhez.github.io/media/posts/10/responsive/ssh-transformed11-xs.jpeg 300w, https://baronhez.github.io/media/posts/10/responsive/ssh-transformed11-sm.jpeg 480w, https://baronhez.github.io/media/posts/10/responsive/ssh-transformed11-md.jpeg 768w, https://baronhez.github.io/media/posts/10/responsive/ssh-transformed11-lg.jpeg 1024w, https://baronhez.github.io/media/posts/10/responsive/ssh-transformed11-xl.jpeg 1360w, https://baronhez.github.io/media/posts/10/responsive/ssh-transformed11-2xl.jpeg 1600w" sizes="(max-width: 1600px) 100vw, 1600px" loading="eager" height="862" width="1300" alt="Eh"></figure><header class="hero__content"><div class="wrapper"><div class="post__meta"><time datetime="2022-08-27T16:33">August 27, 2022</time></div><h1>How to install and configure SSH to be secure</h1><div class="post__meta post__meta--author"><a href="https://baronhez.github.io/jonathan/jonathan-rodenas-lopez/" class="feed__author">Jonathan Ródenas López</a></div></div></header></div><div class="wrapper post__entry"><h2 id="it-should-be-ready-in-just-two-minutes-as-simple-as-that">It should be ready in just two minutes, as simple as that.</h2><p>I will show you how to configure SSH and make it more secure within a couple of minutes.</p><h3 id="connect-to-your-server-using-keys">Connect to your server using keys</h3><p>First, connect to your server using SSH. Oh, don't you have SSH in your server yet? Ok, then, run these commands in your server:</p><pre class="line-numbers language-bash"><code>sudo apt-get install openssh-server
sudo systemctl enable ssh
sudo systemctl start ssh</code></pre><p>Apt-get doesn't work? Ok, you're not using a debian based distro in your server, so you have to search how to install packages in your distro (it is a 1 minuto google search, I promise).</p><p>Ok, now that SSH is working in our server, connect to the server from another computer, just for testing. If it is working, now run this command in your server (is going to create the directory for the keys and change the permissions of that directory):</p><pre class="line-numbers language-bash"><code>mkdir ~/.ssh && chmod 700 ~/.ssh</code></pre><p>Now, we have to generate the keys in our computer.</p><pre class="line-numbers language-bash"><code># For Windows:
ssh-keygen -b 4096
# The keys are stored in "%userprofile%\.ssh" as id_rsa and id_rsa.pub by default.
#Now, transfer the public key to the server.
scp $env:USERPROFILE/.ssh/id_rsa.pub Username@123.445.566.233:~/.ssh/authorized_keys    
# Replace the Username and IP with your own Username and Server IP.
# For Linux:
ssh-keygen -b 4096
# The keys are stored in "~/.ssh" as id_rsa and id_rsa.pub by default.
# Now, transfer the public key to the server.
ssh-copy-id Username@123.445.566.233
# Replace the Username and IP with your own Username and Server IP.
# For Mac:
ssh-keygen -b 4096
# The keys are stored in "~/.ssh" as id_rsa and id_rsa.pub by default.
# Now, transfer the public key to the server.
scp ~/.ssh/id_rsa.pub Username@123.445.566.233:~/.ssh/authorized_keys    
# Replace the Username and IP with your own Username and Server IP.
</code></pre><p>Ok, if you connect now to your server through SSH, you will connect directly, without having to input a password. Now, let's continue with the next step.</p><h3 id="disable-password-login">Disable password login</h3><p>Edit the file&nbsp;<i>/etc/ssh/sshd_config </i>using some editor like Nano or Vim. First, search for the <b>KbdInteractiveAuthentication</b> line and change the value to no. This way is not possible to use a keyboard during&nbsp;authentication. Next thing we have to change is&nbsp; <b>PasswordAuthentication</b>. Again, the default value is yes, but we’ll be setting it to no.</p><p class="msg msg--info">Some people may say something like "Change the ssh port to another one", but a real hacker (most likely a bot) will scan your ports searching for it, so this act is stupid and annoying without any good reason.</p><p class="msg msg--info">You can also disable root login, but since your user will surely have sudo privileges... well, I leave up to you to decide if it is worth it (I have my root login disable).</p><h3 id="remove-weak-prime-numbers">Remove weak prime numbers</h3><p>The client and the server use these moduli to negotiate a secure key. Remove the small ones by runnings these commands:</p><pre class="line-numbers language-bash"><code>cp /etc/ssh/moduli ~/copy_moduli 
awk '$5 &gt;= 3071' /etc/ssh/moduli &gt; /etc/ssh/moduli.safe
mv /etc/ssh/moduli.safe /etc/ssh/moduli    </code></pre><p>The first command makes a security copy before changing the moduli in the home folder of your user. The second command looks for lines in /etc/ssh/moduli, which on the fifth line have a value bigger than 3071 and writes those in the moduli.safe file. Then, the third command replace the moduli using the moduli.safe file.</p><h3 id="allow-strong-cyphers-only">Allow strong cyphers only</h3><p>We are going to allow only the most secure cyphers. Create a new file <i>/etc/ssh/sshd_config.d/ssh_hardening.conf</i>. Then, add this content exactly as it is displayed:</p><pre class="line-numbers language-bash"><code>KexAlgorithms curve25519-sha256,curve25519-sha256@libssh.org,diffie-hellman-group16-sha512,diffie-hellman-group18-sha512,diffie-hellman-group-exchange-sha256
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr
MACs hmac-sha2-256-etm@openssh.com,hmac-sha2-512-etm@openssh.com,umac-128-etm@openssh.com
HostKeyAlgorithms ssh-ed25519,ssh-ed25519-cert-v01@openssh.com,sk-ssh-ed25519@openssh.com,sk-ssh-ed25519-cert-v01@openssh.com,rsa-sha2-256,rsa-sha2-512,rsa-sha2-256-cert-v01@openssh.com,rsa-sha2-512-cert-v01@openssh.com  </code></pre><h2 id="bonus">Bonus</h2><p>With all I mention above should be more than enough, the following tips are optional... and will take you more than just a couple of minutes.</p><h3 id="usenbspmulti-factor-authentication">Use&nbsp;Multi Factor Authentication</h3><p>First, update your system:</p><pre class="line-numbers language-bash"><code>sudo apt update
sudo apt upgrade -y</code></pre><p>Now, install the&nbsp;<i>libpam-google-authenticator</i> package.</p><pre class="line-numbers language-bash"><code>sudo apt install libpam-google-authenticator
</code></pre><p>For MFA, if I'm not mistaken, you will have to enable again the <b>KbdInteractiveAuthentication</b> line in&nbsp;<i>/etc/ssh/sshd_config.</i></p><p>Once the PAM app is installed you will need to use a helper app that comes with the PAM to generate a Time-Based One-Time Password (TOTP) key for the user you want to add a second factor to. This key is generated on a per user basis, and as a result is not system-wide.&nbsp;To do this simply run:</p><pre class="line-numbers language-bash"><code>google-authenticator</code></pre><p>Upon running the command, you’ll be asked a few questions. The first one asks if authentication tokens should be time-based. We want to select <b>y</b>:</p><pre class="line-numbers language-bash"><code>Do you want authentication tokens to be time-based (y/n): y</code></pre><p>Once we select yes, the app will generate a QR code that can be scanned within your authenticator app of choice.</p><p>This PAM allows for time-based or sequential-based tokens. Using sequential-based tokens mean the code starts at a certain point and then increments the code after every use. Using time-based tokens mean the code changes randomly after a certain time elapses (usually 60s). We’ll stick with time-based because that is what apps like Google Authenticator anticipate.</p><p>The remaining questions inform the PAM how to function. We’ll go through them one by one.</p><pre class="line-numbers language-bash"><code>Do you want me to update your "/home/zephr/.google_authenticator" file? (y/n)  </code></pre><p>This writes the key and options to the <b>~/.google_authenticator</b> file. If you select no, then the program will quit and nothing is saved which in turn results in the authenticator application not working. Therefore we want to select <b>yes </b>for this!&nbsp;</p><pre class="line-numbers language-html"><code>By default, tokens are good for 30 seconds and in order to compensate for
possible time-skew between the client and the server, we allow an extra
token before and after the current time. If you experience problems with poor
time synchronization, you can increase the window from its default
size of 1:30min to about 4min. Do you want to do so (y/n) n</code></pre><p>Selecting yes for this question enables up to 8 valid codes in a moving four minute window. By answering no, you limit it to 3 valid codes in a 90 second rolling window.</p><p>Unless you find issues with the 90 second window, answering no is the more secure choice.</p><pre class="line-numbers language-html"><code>If the computer that you are logging into isn't hardened against brute-force
login attempts, you can enable rate-limiting for the authentication module.
By default, this limits attackers to no more than 3 login attempts every 30s.
Do you want to enable rate-limiting (y/n) y</code></pre><p>Rate limiting means a remote attacker can only attempt a certain number of guesses before being blocked. I recommend you to answer <b>yes</b>.</p><p>Once you finish this setup, if you want to back up your secret key, you can copy the <b>~/.google-authenticator</b> file to a trusted location.&nbsp;</p><p>Once we've been through the steps to configure google authenticator, the next step is to setup our SSH config to allow authenticator to function:</p><pre class="line-numbers language-bash"><code>sudo nano /etc/pam.d/sshd</code></pre><p>Add the following line to the bottom of the file:</p><pre class="line-numbers language-bash"><code># Standard Un*x password updating.
@include common-password
auth required pam_google_authenticator.so nullok  </code></pre><p>The <b>nullok</b> word at the end of the last line tells the PAM that this authentication method is optional. This allows users without a OATH-TOTP token to still log in using their SSH key. If you remove <b>nullok</b>&nbsp;from the line, this MFA would be mandatory.</p><p>Next, we’ll configure SSH to support this kind of authentication. Open the SSH configuration file for editing.</p><pre class="line-numbers language-bash"><code>sudo nano /etc/ssh/sshd_config</code></pre><p>&nbsp;We are going to make SSH aware of MFA by adding AuthenticationMethods and UsePAM:</p><pre class="line-numbers language-bash"><code># To disable tunneled clear text passwords, change to no here!
PasswordAuthentication no
#PermitEmptyPasswords no

# Change to yes to enable challenge-response passwords (beware issues with
# some PAM modules and threads)


#ChallengeResponseAuthentication yes
KbdInteractiveAuthentication yes
UsePAM yes
AuthenticationMethods publickey,password publickey,keyboard-interactive</code></pre><p>Save the config and restart the SSH service.</p><pre class="line-numbers language-bash"><code>sudo systemctl reload sshd.service</code></pre><p>Now, you have MFA for your SSH.</p><h3 id="enable-firewall-and-make-use-ofnbspratelimiting">Enable Firewall and make use of&nbsp;Rate-Limiting</h3><p>First, install Uncomplicated Firewall(UFW).</p><pre class="line-numbers language-bash"><code>sudo apt install ufw
</code></pre><p>Now, set a rate limit:</p><pre class="line-numbers language-bash"><code>## ufw limit ssh various usage ##
ufw limit ssh comment 'Rate limit for openssh server'</code></pre><p>When a limit rule is used, ufw will normally allow the connection but will deny connections if an IP address attempts to initiate six or more connections within thirty seconds.</p><p>You can also allow or disallow connections from specific IPs:</p><pre class="line-numbers language-bash"><code>   sudo ufw allow from 1.2.3.4 to any port 22</code></pre><p>The above example only allows connections from 1.2.3.4 to port 22.</p><h3 id="set-up-fail2ban">Set up Fail2Ban</h3><p>We can go a little further by setting up Fail2Ban.&nbsp;Fail2Ban essentially actively looks out for signs of potential password authentication abuses to filter out IP addresses and regularly update the system firewall to suspend these IP addresses for a certain period.</p><p>To install and setup Fail2Ban, run the following commands:</p><pre class="line-numbers language-bash"><code>sudo apt install fail2ban
sudo cp /etc/fail2ban/jail.{conf,local}
sudo nano /etc/fail2ban/jail.local</code></pre><p>To configure Fail2Ban, modify the following lines:</p><pre class="line-numbers language-bash"><code>bantime = 1d</code></pre><p>If you assign a negative value, the ban will be permanent.</p><pre class="line-numbers language-bash"><code>findtime = 10m</code></pre><p><b>findtime</b>&nbsp;defines&nbsp;the time-duration allowed between consecutive login attempts. If the multiple login attempts were made within the time defined by findtime, a ban would be set on the IP.</p><pre class="line-numbers language-bash"><code>maxretry = 5</code></pre><p><b>maxretry</b>&nbsp;defines&nbsp; the exact number of failed login attempts allowed within the findtime. If the number of failed-authorization attempts within the findtime exceeds the maxretry value, the IP would be banned from logging back in.</p><p>Fail2ban also allows you to grant immunity to IP addresses and IP ranges of your choice.</p><pre class="line-numbers language-bash"><code>ignoreip = 127.0.0.1/8 ::1 222.222.222.222 192.168.55.0/24</code></pre><p>Upon setting all the options you want, simply start the service then check the status:</p><pre class="line-numbers language-bash"><code>sudo systemctl start fail2ban
sudo systemctl status fail2ban</code></pre><h2 id="credits">Credits</h2><p>I found all this tweaks and tricks in random sources from internet, but to sum it all, all of them can be found in two webpages, so the credit goes to the authors of <a href="https://disknotifier.com/blog/simple-ssh-security/" target="_blank">https://disknotifier.com/blog/simple-ssh-security/</a> and <a href="https://blog.zsec.uk/locking-down-ssh-the-right-way/" target="_blank">https://blog.zsec.uk/locking-down-ssh-the-right-way</a>/.</p></div><footer class="wrapper post__footer"><p class="post__last-updated">This article was updated on August 27, 2022</p><div class="post__share"></div><div class="post__bio bio"><div class="bio__info"><h3 class="bio__name"><a href="https://baronhez.github.io/jonathan/jonathan-rodenas-lopez/" rel="author">Jonathan Ródenas López</a></h3></div></div></footer></article><nav class="post__nav"><div class="post__nav-inner"><div class="post__nav-prev"><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://baronhez.github.io/assets/svg/svg-map.svg#arrow-prev"/></svg> <a href="https://baronhez.github.io/markdown-beginner-guide/" class="post__nav-link" rel="prev"><span>Previous</span> Markdown Beginner Guide</a></div><div class="post__nav-next"><a href="https://baronhez.github.io/how-to-get-notifications-each-time-someone-enters-your-server/" class="post__nav-link" rel="next"><span>Next</span> How to get notifications each time someone enters your server </a><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://baronhez.github.io/assets/svg/svg-map.svg#arrow-next"/></svg></div></div></nav><div class="post__related related"><div class="wrapper"><h2 class="h5 related__title">You should also read:</h2><article class="related__item"><div class="feed__meta"><time datetime="2022-08-25T01:22" class="feed__date">August 25, 2022</time></div><h3 class="h1"><a href="https://baronhez.github.io/how-to-install-and-activate-windows-10-and-windows-11-completely-for-free-the-easiest-way/">How to install and activate Windows 10 and Windows 11 completely for free (the easiest way)</a></h3></article></div></div></main><footer class="footer"><div class="footer__social"><a href="https://twitter.com/Baronhez1" aria-label="Twitter"><svg><use xlink:href="https://baronhez.github.io/assets/svg/svg-map.svg#twitter"/></svg> </a><a href="https://www.linkedin.com/in/jonathanrodenaslopez/" aria-label="LinkedIn"><svg><use xlink:href="https://baronhez.github.io/assets/svg/svg-map.svg#linkedin"/></svg></a></div><div class="footer__copyright"><p>This is the personal blog of Jonathan Ródenas López.</p></div><button onclick="backToTopFunction()" id="backToTop" class="footer__bttop" aria-label="Back to top" title="Back to top"><svg><use xlink:href="https://baronhez.github.io/assets/svg/svg-map.svg#toparrow"/></svg></button></footer></div><script defer="defer" src="https://baronhez.github.io/assets/js/scripts.min.js?v=f47c11534595205f20935f0db2a62a85"></script><script>window.publiiThemeMenuConfig={mobileMenuMode:'sidebar',animationSpeed:300,submenuWidth: 'auto',doubleClickTime:500,mobileMenuExpandableSubmenus:true,relatedContainerForOverlayMenuSelector:'.top'};</script><script>var images = document.querySelectorAll('img[loading]');

        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script></body></html>